import time
import pandas as pd
import urllib.parse
import re  # Para limpar n√∫meros de telefone
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC

# Caminho do ChromeDriver
caminho_driver = r"C:/Users/kikot/OneDrive/Documents/Whatsapp_auto/chromedriver-win64/chromedriver.exe"

# Configura√ß√µes do Chrome
chrome_options = Options()
chrome_options.add_argument("--no-sandbox")
chrome_options.add_argument("--disable-dev-shm-usage")

# Iniciar ChromeDriver
service = Service(caminho_driver)
driver = webdriver.Chrome(service=service, options=chrome_options)

# Abrir WhatsApp Web
driver.get("https://web.whatsapp.com")
driver.delete_all_cookies()

# Carregar TODAS as abas do Excel
file_path = "C:/Users/kikot/OneDrive/Documents/Whatsapp_auto/chromedriver-win64/planilha_carol.xlsx"
sheets = pd.read_excel(file_path, sheet_name=None, engine='openpyxl')  # L√™ todas as abas

def send_message(phone_number, message):
    """Envia mensagem para o n√∫mero especificado pelo WhatsApp Web."""
    encoded_message = urllib.parse.quote(message)  # Codificar URL
    url = f"https://web.whatsapp.com/send?phone={phone_number}&text={encoded_message}"
    driver.get(url)

    try:
        # Esperar bot√£o de envio e clicar
        send_button = WebDriverWait(driver, 30).until(
            EC.element_to_be_clickable((By.XPATH, "//span[@data-icon='send']"))
        )
        send_button.click()
        time.sleep(11)  # Aguarda envio da mensagem
        print(f"‚úÖ Mensagem enviada para {phone_number}")
    except Exception as e:
        print(f"‚ùå Erro ao enviar mensagem para {phone_number}: {e}")

# Loop para processar todas as abas do Excel
for sheet_name, df in sheets.items():
    print(f"üìå Processando aba: {sheet_name}")

    for _, row in df.iterrows():
        try:
            name = row["Aluno"]
            class_name = row["Turma"]
            location = row["Local"]
            professor = row["Professor"]
            start_date = row["Data de Inicio"]

            # üîπ Ajustar formato da data para DD-MM-YYYY
            if isinstance(start_date, str):
                start_date = pd.to_datetime(start_date, errors='coerce')
            if isinstance(start_date, pd.Timestamp):
                start_date = start_date.strftime("%d-%m-%Y")

            # üîπ Ajustar n√∫mero de telefone (removendo caracteres desnecess√°rios)
            phone_number = str(row["Telefone"]).strip()
            phone_number = re.sub(r"\D", "", phone_number)  # Remove tudo que n√£o for n√∫mero

            if not phone_number.startswith("55"):  # Adiciona +55 se n√£o tiver
                phone_number = "55" + phone_number

            # üîπ Remover "*" da mensagem
            class_name = str(class_name).replace("*", "")
            professor = str(professor).replace("*", "")
            location = str(location).replace("*", "")
            start_date = str(start_date).replace("*", "")

            # üîπ Ajustar hor√°rio para evitar negrito no WhatsApp
            if '-' in class_name:
                parts = class_name.rsplit('-', 1)  # Divide no √∫ltimo h√≠fen
                turma_name = parts[0].strip()
                horario = parts[1].strip()
                horario = horario.replace(":", "h")  # Substituir ":" por "h"

                formatted_class_name = f"{turma_name} - {horario}"
            else:
                formatted_class_name = class_name

            # üîπ Mensagem formatada
            message = (
                "*Secretaria de Esportes de Barueri*\n\n"
                "Voc√™ fez a PR√â-MATR√çCULA no nosso sistema on-line. Para EFETIV√Å-LA, siga as orienta√ß√µes abaixo. Caso N√ÉO COMPARE√áA, perder√° automaticamente a vaga.\n\n"
                f"Turma: {formatted_class_name}\n\n"
                f"1) Compare√ßa no polo: {location}\n\n"
                f"2) Data: {start_date}\n\n"
                f"3) Nome do professor: {professor}\n\n"
                "4)  Chegue 10 minutos antes do hor√°rio da aula.\n\n"
                "5)  Preencha uma ficha de anamnese e question√°rio de sa√∫de. Se tiver problemas de sa√∫de, traga *ATESTADO M√âDICO* que comprove aptid√£o para a atividade f√≠sica.\n\n"
                "6)  V√° com roupas confort√°veis (evite decotes e roupas curtas). Leve garrafinha de √°gua e toalha.\n\n"
                "7)  Este √© um dia at√≠pico devido ao acolhimento dos novos alunos e preenchimento do PAR-Q, que ocorrer√° simult√¢neo √† aula. Pedimos compreens√£o.\n\n"
                "8) *IMPORTANTE:* Faltas devem ser comunicadas ao PROFESSOR RESPONS√ÅVEL. Trocas de hor√°rio, turma ou polo n√£o s√£o permitidas nos primeiros 30 dias, e ser√£o analisadas apenas se houver vaga dispon√≠vel.\n\n"
                "*At√© l√°!*"
            )

            send_message(phone_number, message)

        except Exception as e:
            print(f"‚ö†Ô∏è Erro ao processar aluno na aba {sheet_name}: {e}")

# Fechar navegador ap√≥s envio de mensagens
driver.quit()

print("‚úÖ Mensagens enviadas para todas as abas!")
